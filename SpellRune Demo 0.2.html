<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>SpellRune - Demo</title>
    <style>
        body {
            background-color: #000;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: white;
            font-family: 'Courier New', monospace; /* Fonte estilo retro */
            overflow: hidden;
        }
        canvas {
            background-color: #000;
            border: 4px solid #FFF; /* Borda branca clássica */
            image-rendering: pixelated;
        }
        #ui { position: absolute; top: 10px; text-align: center; width: 100%; pointer-events: none; }
    </style>
</head>
<body>

    <div id="ui">
        <h2>SPELLRUNE</h2>
        <p>Setas: Mover | Z: Confirmar/Interagir | X: Cancelar/Correr</p>
    </div>

    <canvas id="gameCanvas" width="640" height="480"></canvas>

<script>
    /* ================================================================
       1. CONFIGURAÇÃO DE SPRITES (IMAGENS)
       ================================================================
       Para usar suas imagens:
       1. Crie uma pasta 'assets' no GitHub.
       2. Coloque os arquivos .png lá.
       3. Mude o src abaixo (Ex: src = './assets/frisk.png').
    */
    const sprites = {
        player: new Image(),
        enemy: new Image(),
        bg: new Image()
    };
    
    // Caminhos das imagens (Substitua pelos seus arquivos reais!)
    sprites.player.src = './assets/player.png'; 
    sprites.enemy.src = './assets/skeleton.png';
    // sprites.bg.src = './assets/ruins_bg.png';

    /* ================================================================
       2. VARIÁVEIS GLOBAIS E ESTADOS
       ================================================================
    */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // Estados: OVERWORLD (Exploração), DIALOGUE (Texto), BATTLE (Luta)
    let gameState = "OVERWORLD"; 
    
    const keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false, z: false, x: false };
    
    // --- JOGADOR (FRISK) ---
    const player = {
        x: 300, y: 240, w: 20, h: 30,
        speed: 4,
        color: '#3399FF', // Azul se não tiver sprite
        direction: 'down', // Para animação futura
        moving: false
    };

    // --- MAPA (Exploração) ---
    const walls = [
        { x: 0, y: 0, w: 640, h: 40 },   // Topo
        { x: 0, y: 440, w: 640, h: 40 }, // Baixo
        { x: 0, y: 0, w: 40, h: 480 },   // Esquerda
        { x: 600, y: 0, w: 40, h: 480 }, // Direita
        { x: 200, y: 100, w: 100, h: 100 } // Pedra no meio
    ];

    const npcs = [
        { x: 400, y: 200, w: 30, h: 40, color: 'white', text: "Olá humano. Cuidado com os ossos.", type: 'sign' },
        { x: 300, y: 100, w: 40, h: 50, color: 'orange', text: "Vamos lutar!", type: 'enemy' } // Inimigo
    ];

    // --- SISTEMA DE BATALHA ---
    const battle = {
        phase: 'MENU', // MENU, ATTACK, DODGE (Desviar), VICTORY
        enemyName: "Esqueleto",
        hp: 20,
        maxHp: 20,
        turnTimer: 0,
        
        // Caixa da Alma (Bullet Hell Area)
        box: { x: 240, y: 240, w: 160, h: 160 },
        
        // A Alma (Coração Vermelho)
        soul: { x: 320, y: 320, w: 16, h: 16, speed: 3, color: 'red' },
        
        // Projéteis (Ossos/Lanças)
        bullets: [],
        
        // Menu
        menuOptions: ['LUTAR', 'AGIR', 'ITEM', 'POUPAR'],
        menuIndex: 0
    };

    // --- DIÁLOGO ---
    let dialogue = {
        text: "",
        index: 0,
        active: false,
        timer: 0
    };

    /* ================================================================
       3. CONTROLES
       ================================================================
    */
    document.addEventListener('keydown', e => {
        if (keys.hasOwnProperty(e.key) || e.key.startsWith('Arrow')) keys[e.key] = true;
        
        // Interação (Z)
        if (e.key === 'z') {
            if (gameState === 'OVERWORLD') checkInteraction();
            else if (gameState === 'DIALOGUE') advanceDialogue();
            else if (gameState === 'BATTLE' && battle.phase === 'MENU') selectBattleOption();
        }
    });

    document.addEventListener('keyup', e => {
        if (keys.hasOwnProperty(e.key) || e.key.startsWith('Arrow')) keys[e.key] = false;
    });

    /* ================================================================
       4. LÓGICA (UPDATE)
       ================================================================
    */
    function update() {
        if (gameState === 'OVERWORLD') updateOverworld();
        if (gameState === 'BATTLE') updateBattle();
        if (gameState === 'DIALOGUE') updateDialogue();
    }

    // --- LÓGICA DE EXPLORAÇÃO ---
    function updateOverworld() {
        let dx = 0, dy = 0;
        if (keys.ArrowUp) dy = -player.speed;
        if (keys.ArrowDown) dy = player.speed;
        if (keys.ArrowLeft) dx = -player.speed;
        if (keys.ArrowRight) dx = player.speed;

        player.moving = (dx !== 0 || dy !== 0);

        // Colisão X
        player.x += dx;
        for (let w of walls) if (rectIntersect(player, w)) player.x -= dx;
        for (let n of npcs) if (rectIntersect(player, n)) player.x -= dx; // NPC é sólido

        // Colisão Y
        player.y += dy;
        for (let w of walls) if (rectIntersect(player, w)) player.y -= dy;
        for (let n of npcs) if (rectIntersect(player, n)) player.y -= dy;
    }

    function checkInteraction() {
        // Cria uma hitbox um pouco maior pra checar se tem algo perto
        let interactionBox = { x: player.x - 10, y: player.y - 10, w: player.w + 20, h: player.h + 20 };
        
        for (let n of npcs) {
            if (rectIntersect(interactionBox, n)) {
                if (n.type === 'enemy') startBattle();
                else startDialogue(n.text);
                return;
            }
        }
    }

    // --- LÓGICA DE BATALHA ---
    function startBattle() {
        gameState = 'BATTLE';
        battle.phase = 'MENU';
        battle.bullets = [];
        battle.soul.x = 312; battle.soul.y = 312; // Centraliza a alma
    }

    function selectBattleOption() {
        // Simplesmente vai para o turno do inimigo (Bullet Hell)
        // Aqui você adicionaria lógica de ataque ou conversa
        startEnemyTurn();
    }

    function startEnemyTurn() {
        battle.phase = 'DODGE';
        battle.turnTimer = 300; // Duração do ataque (frames)
        battle.bullets = [];
    }

    function updateBattle() {
        // Navegação no Menu
        if (battle.phase === 'MENU') {
            if (keys.ArrowRight) { battle.menuIndex = (battle.menuIndex + 1) % 4; keys.ArrowRight = false; }
            if (keys.ArrowLeft) { battle.menuIndex = (battle.menuIndex + 3) % 4; keys.ArrowLeft = false; }
        }

        // Fase de Desviar (Bullet Hell)
        if (battle.phase === 'DODGE') {
            battle.turnTimer--;
            
            // Movimento da Alma (preso na caixa)
            if (keys.ArrowUp && battle.soul.y > battle.box.y) battle.soul.y -= battle.soul.speed;
            if (keys.ArrowDown && battle.soul.y < battle.box.y + battle.box.h - battle.soul.h) battle.soul.y += battle.soul.speed;
            if (keys.ArrowLeft && battle.soul.x > battle.box.x) battle.soul.x -= battle.soul.speed;
            if (keys.ArrowRight && battle.soul.x < battle.box.x + battle.box.w - battle.soul.w) battle.soul.x += battle.soul.speed;

            // Gerar Projéteis (Ossos caindo)
            if (battle.turnTimer % 10 === 0) {
                let bulletX = battle.box.x + Math.random() * (battle.box.w - 10);
                battle.bullets.push({ x: bulletX, y: battle.box.y, w: 6, h: 20, speed: 3 });
            }

            // Mover e Checar Balas
            for (let i = 0; i < battle.bullets.length; i++) {
                let b = battle.bullets[i];
                b.y += b.speed;
                
                // Colisão com a Alma (Dano)
                if (rectIntersect(battle.soul, b)) {
                    battle.hp -= 1; // Toma dano
                    battle.bullets.splice(i, 1);
                    // Efeito de flash vermelho na tela poderia entrar aqui
                }
                
                // Remove se sair da caixa
                if (b.y > battle.box.y + battle.box.h) {
                    battle.bullets.splice(i, 1);
                    i--;
                }
            }

            // Fim do turno do inimigo
            if (battle.turnTimer <= 0) {
                battle.phase = 'MENU';
            }
            
            // Game Over
            if (battle.hp <= 0) {
                battle.hp = 0;
                // Aqui iria para uma tela de Game Over
            }
        }
    }

    // --- LÓGICA DE DIÁLOGO ---
    function startDialogue(text) {
        gameState = 'DIALOGUE';
        dialogue.text = text;
        dialogue.index = 0;
        dialogue.active = true;
    }

    function updateDialogue() {
        dialogue.timer++;
        if (dialogue.timer % 2 === 0 && dialogue.index < dialogue.text.length) {
            dialogue.index++; // Efeito de digitação
        }
    }

    function advanceDialogue() {
        if (dialogue.index < dialogue.text.length) {
            dialogue.index = dialogue.text.length; // Completa o texto
        } else {
            gameState = 'OVERWORLD'; // Fecha o diálogo
        }
    }

    function rectIntersect(r1, r2) {
        return r2.x < r1.x + r1.w && r2.x + r2.w > r1.x &&
               r2.y < r1.y + r1.h && r2.y + r2.h > r1.y;
    }

    /* ================================================================
       5. RENDERIZAÇÃO (DESENHO)
       ================================================================
    */
    function draw() {
        // Limpa tela
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (gameState === 'OVERWORLD') drawOverworld();
        else if (gameState === 'BATTLE') drawBattle();
        
        // Diálogo é desenhado por cima de tudo
        if (gameState === 'DIALOGUE') drawDialogueBox();
    }

    function drawOverworld() {
        // Paredes
        ctx.fillStyle = '#884400'; // Cor de "Ruínas"
        for (let w of walls) ctx.fillRect(w.x, w.y, w.w, w.h);

        // NPCs
        for (let n of npcs) {
            // Tenta desenhar sprite se for inimigo, senão quadrado
            if (n.type === 'enemy' && sprites.enemy.complete && sprites.enemy.naturalWidth !== 0) {
                ctx.drawImage(sprites.enemy, n.x, n.y, n.w, n.h);
            } else {
                ctx.fillStyle = n.color;
                ctx.fillRect(n.x, n.y, n.w, n.h);
            }
        }

        // Player (Frisk)
        // Se a imagem carregou, desenha ela. Se não, desenha quadrado azul.
        if (sprites.player.complete && sprites.player.naturalWidth !== 0) {
            ctx.drawImage(sprites.player, player.x, player.y, player.w, player.h);
        } else {
            ctx.fillStyle = player.color;
            ctx.fillRect(player.x, player.y, player.w, player.h);
        }
    }

    function drawBattle() {
        // Inimigo no topo
        if (sprites.enemy.complete && sprites.enemy.naturalWidth !== 0) {
            // Centralizado no topo
            ctx.drawImage(sprites.enemy, canvas.width/2 - 50, 50, 100, 120);
        } else {
            ctx.fillStyle = 'white';
            ctx.fillRect(canvas.width/2 - 50, 50, 100, 120);
        }

        // Caixa de Texto / Arena
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 4;
        
        if (battle.phase === 'DODGE') {
            // Caixa Pequena (Bullet Hell)
            ctx.strokeRect(battle.box.x, battle.box.y, battle.box.w, battle.box.h);
            
            // Alma (Coração)
            ctx.fillStyle = battle.soul.color;
            ctx.fillRect(battle.soul.x, battle.soul.y, battle.soul.w, battle.soul.h);
            
            // Projéteis
            ctx.fillStyle = 'white';
            for (let b of battle.bullets) ctx.fillRect(b.x, b.y, b.w, b.h);

        } else {
            // Caixa Grande (Menu/Texto)
            ctx.strokeRect(50, 250, 540, 140);
            
            // Opções do Menu (Botões em baixo)
            ctx.font = '20px Courier New';
            let buttons = battle.menuOptions;
            let startX = 60;
            for (let i = 0; i < buttons.length; i++) {
                ctx.fillStyle = (i === battle.menuIndex) ? 'yellow' : 'orange'; // Selecionado
                ctx.fillText(buttons[i], startX, 450);
                
                // Desenha coraçãozinho no selecionado
                if (i === battle.menuIndex) {
                    ctx.fillStyle = 'red';
                    ctx.fillText('♥', startX - 20, 450);
                }
                startX += 140;
            }
            
            // Texto de batalha
            ctx.fillStyle = 'white';
            ctx.fillText(`* ${battle.enemyName} bloqueia o caminho!`, 70, 290);
        }

        // Barra de HP
        ctx.fillStyle = 'red';
        ctx.fillRect(280, 400, 100, 20); // Fundo
        ctx.fillStyle = 'yellow';
        ctx.fillRect(280, 400, (battle.hp / battle.maxHp) * 100, 20); // HP Atual
        ctx.fillStyle = 'white';
        ctx.font = '16px monospace';
        ctx.fillText(`HP ${battle.hp} / ${battle.maxHp}`, 390, 415);
    }

    function drawDialogueBox() {
        // Caixa preta com borda branca
        ctx.fillStyle = 'black';
        ctx.fillRect(50, 300, 540, 150);
        ctx.strokeStyle = 'white';
        ctx.strokeRect(50, 300, 540, 150);

        // Texto (efeito digitação)
        ctx.fillStyle = 'white';
        ctx.font = '24px Courier New';
        let currentText = dialogue.text.substring(0, dialogue.index);
        ctx.fillText("* " + currentText, 70, 350);
        
        ctx.font = '14px monospace';
        ctx.fillText("[Z] Para avançar", 450, 430);
    }

    // --- LOOP PRINCIPAL ---
    function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
    }
    loop();

</script>
</body>
</html>
